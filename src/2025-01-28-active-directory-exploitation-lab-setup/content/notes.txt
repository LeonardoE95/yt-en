                    _______________________________

                     ACTIVE DIRECTORY EXPLOITATION
                            Laboratory Setup

                                Hexdump
                    _______________________________


Table of Contents
_________________

1. Lab Structure
2. Setup
.. 1. DC01
..... 1. Setup Windows Server 2022
..... 2. Enable AD hexdump.lab
..... 3. Customize AD Controller
.. 2. MS01
..... 1. Setup Windows 10
..... 2. Join Workstation to Domain
3. Why is AD Useful?


1 Lab Structure
===============

  The lab we will be working with has a very simple structure and is
  made up of two different components:

  - `DC01'

    Windows Server 2022

    Domain Controller, core component responsible for managing the
    structure of the Active Directory.

  - `MS01'

    Windows 10

    Simple windows workstation.


2 Setup
=======

2.1 DC01
~~~~~~~~

2.1.1 Setup Windows Server 2022
-------------------------------

  To download and setup `windows server 2022' we can use the `quickemu'
  project:
  - <https://github.com/quickemu-project/quickemu>

  Specifically, download the ISO with `quickget'
  ,----
  | quickget windows-server 2022
  `----

  If instead the ISO is already available
  ,----
  | quickget --create-config windows-server-2022 ./SERVER_EVAL_x64FRE_en-us.iso
  `----

  And start the installation process with quickemu
  ,----
  | quickemu --vm windows-server-2022.conf
  `----

  Follow video on quickemu to setup the rest:
  - [Simple Virtual Machines Setup with Quickemu]


[Simple Virtual Machines Setup with Quickemu]
<https://youtu.be/OXrcMzlFhAg>


2.1.2 Enable AD hexdump.lab
---------------------------

  First, change hostname to `DC01'

  ,----
  | Server manager -> Local server
  |                -> Compuer Name
  |                -> Change
  |                -> "DC01"
  |                -> Restart later
  `----

  Then, enable "Active Directory Domain Services" by using the `server
  manager' application

  ,----
  |  Server manager -> Dashboard
  |                 -> Manage
  |                 -> Add roles and features
  |                 -> Role-based or feature-based installation
  |                 -> Select server 
  |                 -> Check 'active directory domain services'
  |                 -> Add Default Features
  |                 -> Next
  |                 -> Install
  `----

  Reboot the server

  ,----
  | Restart-Server
  `----

  Finally, promote the server to a `domain controller'.

  ,----
  | Server manager -> Flag
  |                -> Promote this server to a domain controller
  |                -> Add new forest
  |                -> "hexdump.lab"
  |                -> Select level functionality "Windows Server 2016"
  |                -> Insert Directory Services Restore Mode (DSRM) Password
  |                -> Skip DNS Options
  |                -> Select NetBIOS domain name "HEXDUMP"
  |                -> Select default paths for Database, Log files and SYSVOL
  |                -> Next towards Prerequisites Check
  |                -> Install
  `----

  Notice that the DSRM Password is not linked to any user of the AD, and
  it is used during disaster recovery situations.

  Once this process is finished, the server will reboot.


2.1.3 Customize AD Controller
-----------------------------

  To customize our AD lab, we need to create a new `Group Policy Object'
  (GPO).  We can do this within the within the `Group Policy Management'
  editor.

  ,----
  | Win + R
  | gpmc.msc
  `----

  Add a new GPO called "Hexdump Lab Policy".

  ,----
  | Group Policy Management -> Forest: hexdump.lab
  |                         -> Domains
  |                         -> hexdump.lab
  |                         -> Right click "Create a GPO in this domain and Link it here..."
  |                         -> Name "Hexdump Lab Policy"
  `----

  Modify the newly created policy as follows

  ,----
  | Hexdump Lab Policy -> Edit
  `----

  - Disable automatic updates

    ,----
    | Computer Configuration > Policies
    |                        > Administrative Templates
    |                        > Windows Components
    |                        > Windows Update
    |                        > Set "Configure Automatic Updates" to "Disabled"
    `----

  - Disable real time protection

    ,----
    | Computer Configuration > Administrative Templates
    |                        > Windows Components
    |                        > Microsoft Defender Antivirus
    |                        > Real-time Protection
    |                        > Set "Turn off real-time protection" to "Enabled"
    `----

  To make sure the GPO changes take effect
  ,----
  | gpupdate /force
  `----

  ----------------------------------------------------------------------

  To create new AD users
  ,----
  | New-ADUser -Name "leo" -SamAccountName "leo" -UserPrincipalName "leo@hexdump.lab" -ACcountPassword (ConvertTo-SecureString -AsPlainText "Hexdump123!" -Force) -Enabled $true
  `----

  Enable user
  ,----
  | Enable-ADAccount -Identity "leo"
  `----

  Make the newly created user a aservice account.
  ,----
  | Set-ADUser -Identity leo -ServicePrincipalNames @{Add="HTTP/webserver.hexdump.lab"}
  `----

  Make sure we have created it with
  ,----
  | Get-ADUser -Identity leo -Properties ServicePrincipalNames
  `----


2.2 MS01
~~~~~~~~

2.2.1 Setup Windows 10
----------------------

  To download and setup `windows 10' we can use the `quickemu' project:
  - <https://github.com/quickemu-project/quickemu>

  Specifically, download the ISO with `quickget'
  ,----
  | quickget windows 10
  `----

  If instead the ISO is already available
  ,----
  | quickget --create-config windows-10 ./Win10_22H2_EnglishInternational_x64v1.iso
  `----

  And start the installation process with quickemu
  ,----
  | quickemu --vm windows-10.conf
  `----

  Follow video on quickemu to setup the rest:
  - [Simple Virtual Machines Setup with Quickemu]


[Simple Virtual Machines Setup with Quickemu]
<https://youtu.be/OXrcMzlFhAg>


2.2.2 Join Workstation to Domain
--------------------------------

  Before trying to join the workstation to the domain we must configure
  the DNS server to point to the AD DNS. This is important, as, when
  using QEMU, the default DNS server used is the one used by QEMU, for
  example `192.168.122.1'.

  To change the DNS do the following
  ,----
  | Win + R
  | ncpa.cpl
  | Select network interface of interest
  | Click properties
  | Configure IPv4 settings
  | Set DNS server to the AD DNS
  `----

  Once this change is done, you can test connectivity by using
  `nslookup'. If the domain name is resolved to the proper IP, then
  we're good!

  ,----
  | PS C:\Users\Quickemu> nslookup -type=SRV dc01.hexdump.lab
  | Server:  DC01
  | Address:  192.168.122.251
  | 
  | hexdump.lab
  |         primary name server = dc01.hexdump.lab
  |         responsible mail addr = hostmaster.hexdump.lab
  |         serial  = 20
  |         refresh = 900 (15 mins)
  |         retry   = 600 (10 mins)
  |         expire  = 86400 (1 day)
  |         default TTL = 3600 (1 hour)
  `----

  At this point we can join the workstation to the domain. To finish the
  procedure you will need to inser the credential of a user who has the
  required permissions, such as a domain admin account.
  ,----
  | Control Panel -> System and Security
  |               -> System
  |               -> Advanced system settings
  |               -> Computer Name
  |               -> Change
  |               -> Domain
  |               -> "hexdump.lab"
  `----

  To check that the workstation has been correctly joined to the AD, you
  can use the following different commands
  ,----
  | systeminfo | findstr /B /C:"Domain"
  `----

  ,----
  |  Get-WmiObject -Class Win32_ComputerSystem | Select-Object Domain
  `----


3 Why is AD Useful?
===================

  From an enterprise perspective, the power of Active Directory (AD)
  lies in the centralization of services. That is, AD is perfect for
  managing and organizing resources within an enterprise network.

  Consider for example the configuration of security related settings
  such as

  - password policies,
  - screen lock timeouts
  - installation of security updates.

  Without a centralized solution such as Active Directory, sysadmins
  would be required to configure each device manually, which is
  inefficient, error-prone and does not scale well as the number of
  employees grow.

  With AD instead it is possible to define Group Policy (GPOs) at the
  level of the Domain and AD will make sure these policies are enforced
  throughout the network.

  ----------------------------------------------------------------------

  For a small and practical example to build intuition on the subject,
  consider the problem of automatic locking the workstation of employees
  after a certain window of time has passed.

  It is possible to create a new policy configuration by going into the
  Group Policy Management (gpmc.msc) and navigating to

  ,----
  | User Configuration -> Policies
  |                    -> Administrative Templates
  |                    -> Control Panel
  |                    -> Personalization
  `----

  Enable the `Screen Saver Timeout' and set the value to the timeout
  desired, such as 1 minute, for example.

  Other options of interest are `Password Protect the Screen Saver' and
  `Force Logoff when Logon Hours Expire'.

  ----------------------------------------------------------------------

  Other interesting usages of ADs:

  - Disable USB Devices
  - Configure Windows Update Policies
  - Password Complexity requirements
